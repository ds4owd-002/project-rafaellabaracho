---
library(usethis)
use_git_config(user.name = "", user.email = "")---
title: "Capstone Project - rafaellabaracho "
format:
  html:
    toc: true
    toc-location: left
    number-sections: true
    toc-depth: 3         

editor: visual
author:
    - name: "Rafaella Oliveira Baracho"
      orcid: 0000-0002-4063-1902
      email: rafaella.baracho.ifbaiano@gmail.com
      affiliation: 
        - name: IF Baiano Campus Xique-Xique 
          url: https://www.ifbaiano.edu.br/unidades/xique-xique/projeto-agua-esgoto-e-higiene-na-area-rural-o-quao-proximos-estamos-das-metas-da-agenda-2030/
        - name: Lund University 
          url: https://www.lunduniversity.lu.se/lucat/user/465ba918a74230e0916baef66f5713aa 
date: 2025-12-09
execute: 
  echo: true #item 3
  warning: false #item 3
bibliography: capstoneproject.bib
---

```{r}
#Item 20
```

# Introduction

Safe water supply and sanitation are fundamental to hygiene, food security, and human dignity, yet rural areas in Brazil still face major deficits in access to these services. Beyond infrastructure gaps, the absence of water quality monitoring, combined with hygiene practices, cultural habits, and the management of household systems, can generate sanitary insecurity ( @al-mekhlafi_giardia_2017, @string_systematic_2016 ). Rainwater harvesting is crucial in semi-arid regions ( @hassan_correction_2025 ), but household treatment and maintenance remain essential. This study compares turbidity, electrical conductivity and pH in cisterns and points of consumption and evaluates household water practices.

# Methods

## The community

The rural community selected is Itapicuru Community, in Xique-Xique, Bahia, which does not have a collective water supply system. The community has 18 households, 16 of which are occupied by families.

## Statistical treatment

Minimum sample size with 95% confidence intervals was calculated following @scalize_diagnostico_2022 .

In the calculations, “p” was defined as 0.5, representing maximum variability for proportion estimates, since these values are widely used by @scalize_diagnostico_2022 in rural areas. Subsequently, water samples for human consumption were collected and their physical-chemical analysis was performed, according to procedures established by @ministerio_da_saude_portaria_2021 and @organization_guidelines_2022 . For 14 household, two 1-liter samples were collected: one from the water storage reservoir (rainwater cistern, water tank, among others) and one from the point of consumption for direct ingestion (water bottle, filter, among others). pH, turbidity, and electrical conductivity were analyzed in triplicate. Finally, a survey was applied to 16 household, to understand household treatment practices.

```{r}
#Itens 17, 18 and 19
library(readr)
library(here)
library(dplyr) 

water_qual_xx <- read_delim(
  here::here("data", "raw", "water_quality_data_xx_final.csv"),
  delim = ";",
  locale = locale(decimal_mark = ".", grouping_mark = ",")
)

water_qual_xx <- water_qual_xx[ rowSums(is.na(water_qual_xx)) < ncol(water_qual_xx), ]
water_qual_xx_proc <- water_qual_xx |>
  select(-`Owner name`)
write_delim(
  water_qual_xx_proc,
  here::here("data", "processed", "water_quality_data_xx_final_processed.csv"),
  delim = ";"
)
```

# Results

In this community, 62.5% of households use rainwater as their main source, 6.2% bottled water, 18.75% water delivered by tanker truck and 12.5% river water, which overall suggests that, for these parameters, drinking-water quality is generally close to safe levels. It is worth highlighting that rainwater is often a relatively good-quality and usually safe source in semi-arid regions when adequately collected and stored.

```{r}
#| label: tbl-desc-stat
#| tbl-cap: "Descriptive statistics of water quality parameters at household reservoirs and points of consumption"
#Bsic statistics
library(dplyr)
library(writexl)
library(ggplot2)
library(readr)
library(gt)



water_qual_xx_final <- water_qual_xx_proc |>
  rename(
    Sample                 = `Sample - 24/05/2025`,
    Specific_sampling_place = `Specific sampling place`,
    Conductivity1          = `Conductivity 1`,
    Conductivity2          = `Conductivity 2`,
    Conductivity3          = `Conductivity 3`
  ) |>
  mutate(
    Specific_sampling_place = factor(
      Specific_sampling_place,
      levels = c("Reservoir", "Point of consumption")
    ),
    pH_final = rowMeans(across(c(pH1, pH2, pH3)), na.rm = TRUE),
    Conductivity_final = rowMeans(across(c(Conductivity1, Conductivity2, Conductivity3)), na.rm = TRUE),
    Turbidity_final = rowMeans(across(c(Turbidity1, Turbidity2, Turbidity3)), na.rm = TRUE)
  )


desc_stats <- water_qual_xx_final |>
  group_by(Specific_sampling_place) |>
  summarise(
    n_pH        = sum(!is.na(pH_final)),
    mean_pH     = mean(pH_final, na.rm = TRUE),
    sd_pH       = sd(pH_final, na.rm = TRUE),
    median_pH   = median(pH_final, na.rm = TRUE),
    IQR_pH      = IQR(pH_final, na.rm = TRUE),
    min_pH      = min(pH_final, na.rm = TRUE),
    max_pH      = max(pH_final, na.rm = TRUE),

    n_Cond      = sum(!is.na(Conductivity_final)),
    mean_Cond   = mean(Conductivity_final, na.rm = TRUE),
    sd_Cond     = sd(Conductivity_final, na.rm = TRUE),
    median_Cond = median(Conductivity_final, na.rm = TRUE),
    IQR_Cond    = IQR(Conductivity_final, na.rm = TRUE),
    min_Cond    = min(Conductivity_final, na.rm = TRUE),
    max_Cond    = max(Conductivity_final, na.rm = TRUE),

    n_Turb      = sum(!is.na(Turbidity_final)),
    mean_Turb   = mean(Turbidity_final, na.rm = TRUE),
    sd_Turb     = sd(Turbidity_final, na.rm = TRUE),
    median_Turb = median(Turbidity_final, na.rm = TRUE),
    IQR_Turb    = IQR(Turbidity_final, na.rm = TRUE),
    min_Turb    = min(Turbidity_final, na.rm = TRUE),
    max_Turb    = max(Turbidity_final, na.rm = TRUE)
  )

# View in R
desc_stats

# Save table to Excel
write_xlsx(desc_stats, "desc_stats_water_quality.xlsx")

library(dplyr)
library(gt)



tab_pH <- desc_stats |>
  transmute(
    Parameter      = "pH",
    Location       = Specific_sampling_place,
    `Mean (SD)`    = sprintf("%.2f (%.2f)", mean_pH, sd_pH),
    `Median (IQR)` = sprintf("%.2f (%.2f)", median_pH, IQR_pH),
    `Min–Max`      = sprintf("%.2f–%.2f", min_pH, max_pH)
  )

tab_cond <- desc_stats |>
  transmute(
    Parameter      = "Electrical Conductivity (µS/cm)",
    Location       = Specific_sampling_place,
    `Mean (SD)`    = sprintf("%.2f (%.2f)", mean_Cond, sd_Cond),
    `Median (IQR)` = sprintf("%.2f (%.2f)", median_Cond, IQR_Cond),
    `Min–Max`      = sprintf("%.2f–%.2f", min_Cond, max_Cond)
  )

tab_turb <- desc_stats |>
  transmute(
    Parameter      = "Turbidity (NTU)",
    Location       = Specific_sampling_place,
    `Mean (SD)`    = sprintf("%.2f (%.2f)", mean_Turb, sd_Turb),
    `Median (IQR)` = sprintf("%.2f (%.2f)", median_Turb, IQR_Turb),
    `Min–Max`      = sprintf("%.2f–%.2f", min_Turb, max_Turb)
  )

table_for_gt <- bind_rows(tab_pH, tab_cond, tab_turb)

table_for_gt |>
  gt(groupname_col = "Parameter") |>
  tab_header(
    title    = "Table 1 - Descriptive statistics of water quality parameters at household reservoirs and points of consumption",
    subtitle = "Itapicuru, Xique-Xique, Brazil"
  ) |>
  cols_label(
    Location       = "Location",
    `Mean (SD)`    = "Mean (SD)",
    `Median (IQR)` = "Median (IQR)",
    `Min–Max`      = "Min–Max",
    Parameter = "Parameter (unit)"
  )


```

The results regarding the basic statistics are shown in @tbl-desc-stat . These results shown the general status of water quality. Mean values of pH, electrical conductivity and turbidity complied with @ministerio_da_saude_portaria_2021 and @organization_guidelines_2022 drinking-water recommendations at both sampling points (reservoir and point of consumption), except for turbidity at the reservoir. Although pH and electrical conductivity are not usually of direct health concern, they remain important operational parameters for monitoring and system control @ramos_-_parra_risk_2025 . In this community, different household water-treatment practices are used: 43.7% of households reported filtering their water, and 81.2% reported switching from rainwater to water delivered by tanker truck during the dry season. Following, the results for each parameter will be presented in box plots.

```{r}

#all statistic for all box plots, before plotting
## Color palette

pal_sampling <- c(
"Reservoir"            = "#B9B6AD",
"Point of consumption" = "#C28C7A"
)

make_stats <- function(df, var, group) {
df |>
group_by({{ group }}) |>
summarise(
min    = min({{ var }}, na.rm = TRUE),
median = median({{ var }}, na.rm = TRUE),
mean   = mean({{ var }}, na.rm = TRUE),
max    = max({{ var }}, na.rm = TRUE),
Q1     = quantile({{ var }}, 0.25, na.rm = TRUE),
Q3     = quantile({{ var }}, 0.75, na.rm = TRUE),
.groups = "drop"
)
}

ph_stats   <- make_stats(water_qual_xx_final, pH_final,           Specific_sampling_place)
turb_stats <- make_stats(water_qual_xx_final, Turbidity_final,    Specific_sampling_place)
cond_stats <- make_stats(water_qual_xx_final, Conductivity_final, Specific_sampling_place)

ph_range   <- diff(range(water_qual_xx_final$pH_final,           na.rm = TRUE))
turb_range <- diff(range(water_qual_xx_final$Turbidity_final,    na.rm = TRUE))
cond_range <- diff(range(water_qual_xx_final$Conductivity_final, na.rm = TRUE))

ph_stats <- ph_stats |>
mutate(
mean_y   = Q3 + 0.03 * ph_range,
median_y = Q3 + 0.08 * ph_range
)

turb_stats <- turb_stats |>
mutate(
mean_y   = Q3 + 0.03 * turb_range,
median_y = Q3 + 0.08 * turb_range
)

cond_stats <- cond_stats |>
mutate(
mean_y   = Q3 + 0.03 * cond_range,
median_y = Q3 + 0.08 * cond_range
)

#colors and sizes, already tested

box_width  <- 0.70

base_theme <- theme_bw() +
theme(
legend.position = "none",
plot.margin = margin(3, 5, 3, 5),
axis.title.x = element_text(margin = margin(t = 4)),
axis.title.y = element_text(margin = margin(r = 4))
)

```

At @fig-box-ph, for pH, the mean and median values at the two sampling locations were very similar, indicating that there was no relevant change in pH along the path from the reservoir to the point of consumption.

```{r}
#| label: fig-box-ph
#| fig-cap: "pH of rainwater at household reservoirs and water at households points of consumption in Itapicuru, Xique-Xique, Brazil."

## pH
p_box_pH_labels <- ggplot(
water_qual_xx_final,
aes(x = Specific_sampling_place,
y = pH_final,
fill = Specific_sampling_place)
) +
geom_boxplot(width = box_width) +
scale_fill_manual(values = pal_sampling) +
scale_x_discrete(expand = expansion(mult = c(0, 0))) +

# max

geom_text(
data = ph_stats,
aes(y = max, label = paste0("max=", round(max, 2))),
vjust = -0.3, size = 3
) +

# min

geom_text(
data = ph_stats,
aes(y = min, label = paste0("min=", round(min, 2))),
vjust = 1.3, size = 3
) +

# median (outside box)

geom_text(
data = ph_stats,
aes(y = median_y, label = paste0("med=", round(median, 2))),
size = 3
) +

# mean (outside box)

geom_text(
data = ph_stats,
aes(y = mean_y, label = paste0("mean=", round(mean, 2))),
size = 3
) +
labs(
x = "Specific sampling place",
y = "pH",
title = "pH by sampling place"
) +
coord_cartesian(clip = "off") +
base_theme

p_box_pH_labels

```

For turbidity, the box plots at @fig-box-turb show that variability in the samples collected at the point of consumption was lower than in the reservoir. Processes such as sedimentation and filtration may account for this difference, since the community adopts these practices for household water treatment.

```{r}
#| label: fig-box-turb
#| fig-cap: "Turbidity of rainwater at household reservoirs and points of consumption in Itapicuru, Xique-Xique, Brazil."

## turb

p_box_turb_labels <- ggplot(
water_qual_xx_final,
aes(x = Specific_sampling_place,
y = Turbidity_final,
fill = Specific_sampling_place)
) +
geom_boxplot(width = box_width) +
scale_fill_manual(values = pal_sampling) +
scale_x_discrete(expand = expansion(mult = c(0, 0))) +
geom_hline(
yintercept = 5,
linetype   = "dashed"
) +

# highlight points > 5

geom_point(
data = subset(water_qual_xx_final, Turbidity_final > 5),
aes(x = Specific_sampling_place, y = Turbidity_final),
inherit.aes = FALSE,
size = 3.2
) +

# max

geom_text(
data = turb_stats,
aes(y = max, label = paste0("max=", round(max, 2))),
vjust = -0.3, size = 3
) +

# min

geom_text(
data = turb_stats,
aes(y = min, label = paste0("min=", round(min, 2))),
vjust = 1.3, size = 3
) +

# median (outside box)

geom_text(
data = turb_stats,
aes(y = median_y, label = paste0("med=", round(median, 2))),
size = 3
) +

# mean (outside box)

geom_text(
data = turb_stats,
aes(y = mean_y, label = paste0("mean=", round(mean, 2))),
size = 3
) +
labs(
x = "Specific sampling place",
y = "Turbidity (NTU)",
title = "Turbidity by sampling place"
) +
coord_cartesian(clip = "off") +
base_theme

p_box_turb_labels

```

Finally, for conductivity, @fig-box-cond, the variation at the point of consumption is slightly higher; however, the mean and median values are similar, suggesting that there is no substantial change, which could otherwise occur, for example, due to the addition of contaminants.

```{r}
#| label: fig-box-cond
#| fig-cap: "Electrical conductivity of rainwater at household reservoirs and points of consumption in Itapicuru, Xique-Xique, Brazil."

## Conductivity boxplot

p_box_cond_labels <- ggplot(
water_qual_xx_final,
aes(x = Specific_sampling_place,
y = Conductivity_final,
fill = Specific_sampling_place)
) +
geom_boxplot(width = box_width) +
scale_fill_manual(values = pal_sampling) +
scale_x_discrete(expand = expansion(mult = c(0, 0))) +

# max

geom_text(
data = cond_stats,
aes(y = max, label = paste0("max=", round(max, 2))),
vjust = -0.3, size = 3
) +

# min

geom_text(
data = cond_stats,
aes(y = min, label = paste0("min=", round(min, 2))),
vjust = 1.3, size = 3
) +

# median (outside box)

geom_text(
data = cond_stats,
aes(y = median_y, label = paste0("med=", round(median, 2))),
size = 3
) +

# mean (outside box)

geom_text(
data = cond_stats,
aes(y = mean_y, label = paste0("mean=", round(mean, 2))),
size = 3
) +
labs(
x = "Specific sampling place",
y = "Conductivity (µS/cm)",
title = "Conductivity by sampling place"
) +
coord_cartesian(clip = "off") +
base_theme

p_box_cond_labels

```

All the results are better than in @ramos_-_parra_risk_2025, suggesting that the rainwater is a safe water source, from the point of view of these parameters.

# Conclusions

-   These results indicate no differences between water from the reservoir and from the point of consumption, but it´s still worthy apply Shapiro-Wilk tests.

-   Even though the measured parameters generally comply with standards, it is important to note that the community mainly relies on rainwater and switches to tanker-truck water during drought periods.

-   Since the household treatment methods did not produce detectable changes in pH, electrical conductivity or turbidity, targeted actions are needed to strengthen and ensure the correct application of treatment techniques.

# Disclaimer

**Disclaimer to follow General Data Protection Regulation instructions:**

ChatGPT (OpenAI) was used to assist with coding scripts and improving language clarity. The author retain responsibility for checking and validating all outputs.

# References
